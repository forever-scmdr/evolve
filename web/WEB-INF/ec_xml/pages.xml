<?xml version="1.0" encoding="UTF-8"?>
<site>

    <!-- ******************************* Включение для разделов каталога ****************************** -->
    <include-definition name="COMMON">
        <link name="feedback_link" target="feedback_ajax"/>
        <single item="custom_pages" id="custom_pages" cacheable="false">
            <tree item="custom_page" id="custom_page" tag="menu_custom">
                <link name="show_page" target="page" type="exclusive">
                    <var name="p" ref="custom_page" style="translit"/>
                </link>
            </tree>
        </single>

        <list item="news" id="news" cacheable="false">
            <link name="show_page" target="news" type="exclusive">
                <var name="sel" ref="news" style="translit"/>
            </link>
        </list>

        <single item="common" cacheable="false">
            <list item="soc_link"/>
        </single>
        <link name="contacts_link" target="contacts"/>
        <link name="search_link" target="search"/>
        <link name="feedback_form_link" target="feedback_ajax"/>
        <single item="modules">
            <list item="named_code"/>
        </single>
        <single item="url_seo_wrap">
            <list item="url_seo"/>
        </single>
    </include-definition>


    <page name="index" template="index" cacheable="false">
        <request>
            <var name="limit" value="3"/>
            <var name="page" value="1"/>
        </request>
        <single item="main_page" id="main">
            <single item="seo"/>
            <list item="featured">
                <filter>
                    <limit>
                        <var value="3"/>
                    </limit>
                </filter>
            </list>
        </single>
        <single item="news_wrap">
            <list item="news_item" id="ni" transit="true">
                <filter>
                    <sorting direction="DESC">
                        <var value="date"/>
                    </sorting>
                    <limit>
                        <var var="limit"/>
                    </limit>
                    <pages>
                        <var var="page"/>
                    </pages>
                </filter>
                <single item="top_gal"/>
                <link name="show_page" target="news_item" type="exclusive">
                    <var name="sel" ref="ni" style="translit"/>
                </link>
            </list>
        </single>
        <link name="load_more" target="news_ajax"/>
        <list item="custom_page" tag="custom" id="article">
            <link name="show_page" target="page" type="exclusive">
                <var name="p" ref="article" style="translit"/>
            </link>
        </list>
        <include name="COMMON"/>
    </page>

    <page name="news_ajax" template="news_ajax">
        <request>
            <var name="limit" value="3"/>
            <var name="page" value="2"/>
        </request>
        <single item="news_wrap">
            <list item="news_item" id="ni" transit="true">
                <filter>
                    <sorting direction="DESC">
                        <var value="date"/>
                    </sorting>
                    <limit>
                        <var var="limit"/>
                    </limit>
                    <pages>
                        <var var="page"/>
                    </pages>
                </filter>
                <single item="top_gal"/>
                <link name="show_page" target="news_item" type="exclusive">
                    <var name="sel" ref="ni" style="translit"/>
                </link>
            </list>
        </single>
        <link name="load_more" target="news_ajax"/>
    </page>

    <page name="search" template="search">
        <request>
            <var name="q"/>
            <var name="view" value="table" scope="cookie"/>
        </request>
        <list item="searchable" id="prod">
            <filter>
                <fulltext limit="48" compare="EVERY">
                    <var var="q"/>
                </fulltext>
            </filter>
            <link name="show_page" target="page" type="exclusive">
                <var name="prod" ref="prod" style="translit"/>
            </link>
            <link name="show_news_item" target="news_item" type="exclusive">
                <var name="prod" ref="prod" style="translit"/>
            </link>
            <ancestor item="news_item" id="ni">
                <link name="show_news_item" target="news_item" type="exclusive">
                    <var name="prod" ref="ni" style="translit"/>
                </link>
            </ancestor>
            <ancestor item="custom_page" id="cp">
                <link name="show_page" target="page" type="exclusive">
                    <var name="prod" ref="cp" style="translit"/>
                </link>
            </ancestor>
        </list>
        <include name="COMMON"/>
    </page>

    <page name="news" template="news" cacheable="false">
        <request>
            <var name="sel" style="translit"/>
            <var name="p" value="1"/>
        </request>
        <single item="news" var="sel" tag="selected_news">
            <single item="seo"/>
            <list item="news_item" id="ni">
                <filter>
                    <sorting direction="DESC">
                        <var value="date"/>
                    </sorting>
                    <limit>
                        <var value="2"/>
                    </limit>
                    <pages>
                        <var name="p" var="p"/>
                    </pages>
                </filter>
                <link name="show_news_item" target="news_item" type="exclusive">
                    <var name="ni" ref="ni" style="translit"/>
                </link>
            </list>
        </single>
        <include name="COMMON"/>
    </page>

    <page name="news_item" template="news_item" cacheable="false">
        <request>
            <var name="ni" style="translit"/>
        </request>
        <single item="news_item" var="ni" cacheable="false" cache-vars="ni">
            <single item="seo"/>
            <single item="top_gal"/>
            <single item="comments" id="comment">
                <tree item="comment"/>
                <link name="comment_link" target="comment_ajax">
                    <var name="id" ref="comment"/>
                    <var name="big_id" ref="comment"/>
                </link>
            </single>
            <ancestor item="news"/>
        </single>
        <include name="COMMON"/>
    </page>

    <page name="page" template="page">
        <request>
            <var name="p" style="translit"/>
        </request>
        <single item="custom_page" var="p"/>
        <include name="COMMON"/>
    </page>


    <page name="contacts" template="contacts" cacheable="false">
        <single item="contacts" cacheable="false">
            <single item="seo"/>
        </single>
        <include name="COMMON"/>
    </page>

    <page name="feedback_ajax" template="feedback_ajax">
        <request>
            <var name="result"/>
            <var name="message"/>
        </request>
        <new item="feedback_form" id="form">
            <parameter-input ref="form" form="feedback"/>
        </new>
        <link name="submit_link" target="feedback_command" type="itemform">
            <var name="form_name" value="feedback"/>
            <var name="source_page" value="feedback_ajax"/>
        </link>
    </page>

    <page name="comment_ajax" template="comment_ajax">
        <request>
            <var name="id"/>
            <var name="big_id"/>
            <var name="result"/>
            <var name="message"/>
        </request>

        <single item="comments" var="big_id" id="comments">
            <tree item="comment"/>
            <link name="comment_link" target="comment_ajax">
                <var name="id" ref="comments"/>
                <var name="big_id" var="big_id"/>
            </link>
        </single>

        <new item="comment" id="form" tag="comment_form">
            <parameter-input ref="form" form="feedback"/>
        </new>
        <link name="submit_link" target="comments_command" type="itemform">
            <var name="big_id" var="big_id"/>
            <var name="form_name" value="feedback"/>
            <var name="source_page" value="comment_ajax"/>
        </link>
    </page>


    <page name="feedback_command">
        <request>
            <var name="topic" value="Обратная связь"/>
            <var name="email" value="bio@forever-ds.com"/>
            <var name="form_name"/>
            <var name="source_page"/>
            <var name="required" value="phone|email, message"/>
        </request>
        <link name="success" target-var="source_page">
            <var name="result" value="success"/>
            <var name="message" value="Сообщение успешно отправлено, спасибо"/>
        </link>
        <link name="error_not_set" target-var="source_page">
            <var name="result" value="error"/>
            <var name="message" value="Заполните, пожалуйста, все поля"/>
        </link>
        <link name="general_error" target-var="source_page">
            <var name="result" value="error"/>
            <var name="message"
                 value="Сообщение не может быть отправлено сейчас из-за ошибки сервера. Пожалуйста, попробуйте позже."/>
        </link>
        <command class="ecommander.fwk.NonemptyEmailCommand">
            <result name="success" type="redirect"/>
            <result name="error_not_set" type="redirect"/>
            <result name="general_error" type="redirect"/>
        </command>
    </page>

    <page name="comments_command">
        <request>
            <var name="big_id"/>
            <var name="id"/>
            <var name="source_page"/>
        </request>
        <link name="success" target-var="source_page">
            <var name="big_id" var="big_id"/>
            <var name="result" value="success"/>
            <var name="message" value="Комментарий отправлен, спасибо"/>
        </link>
        <link name="error_not_set" target-var="source_page">
            <var name="big_id" var="big_id"/>
            <var name="result" value="error"/>
            <var name="message" value="Заполните, пожалуйста, обязательные поля"/>
        </link>
        <link name="general_error" target-var="source_page">
            <var name="big_id" var="big_id"/>
            <var name="result" value="error"/>
            <var name="message"
                 value="Комментарий не может быть отправлен сейчас из-за ошибки сервера. Пожалуйста, попробуйте позже."/>
        </link>
        <command class="extra.CommentCommand">
            <result name="success" type="redirect"/>
            <result name="error_not_set" type="redirect"/>
            <result name="general_error" type="redirect"/>
        </command>
    </page>

    <!-- ГЕНЕРАЦИЯ КАРТЫ САЙТА -->
    <page name="sitemap" template="sitemap" cacheable="false">
        <headers content-type="xml"/>
        <single item="url_seo_wrap"/>

        <list item="custom_page" id="custom_page" cacheable="false">
            <link name="show_page" target="page" type="exclusive">
                <var name="p" ref="custom_page" style="translit"/>
            </link>
        </list>
        <list item="news" id="news" cacheable="false">
            <link name="show_page" target="news" type="exclusive">
                <var name="sel" ref="news" style="translit"/>
            </link>
        </list>

        <link name="contacts_link" target="contacts"/>

        <list item="news_item" id="ni">
            <filter>
                <sorting direction="DESC">
                    <var value="date"/>
                </sorting>
            </filter>
            <link name="show_news_item" target="news_item" type="exclusive">
                <var name="ni" ref="ni" style="translit"/>
            </link>

        </list>
    </page>

    <page name="generate_sitemap">
        <command class="ecommander.fwk.CreateSiteMap">
            <result name="complete" type="xml"/>
        </command>
    </page>


    <page name="delete_seo">
        <link name="success" target="delete_seo_complete">
            <var name="message" value="all OK. Seo is deleted"/>
        </link>
        <link name="error" target="delete_seo_complete"/>
        <command class="extra.ExterminateSEO">
            <result name="success" type="redirect"/>
            <result name="error" type="redirect"/>
        </command>
    </page>

    <page name="delete_seo_complete">
        <request>
            <var name="message"/>
        </request>
    </page>


</site>