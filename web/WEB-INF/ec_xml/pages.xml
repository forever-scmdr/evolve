<?xml version="1.0" encoding="UTF-8"?>
<site>

<!-- ******************************* Включение для разделов каталога ****************************** -->

	<include-definition name="COMMON">
		<single item="catalog" id="catalog_main" cacheable="true">
			<tree item="section" id="sec">
				<link name="show_section" target="section" type="exclusive">
					<var name="sec" ref="sec" style="translit"/>
				</link>
			</tree>
		</single>
		<single item="common" cacheable="false"/>
		<link name="index_link" target="index"/>
		<link name="catalog_link" target="catalog"/>
		<link name="news_link" target="news"/>
		<link name="articles_link" target="articles"/>
		<link name="dealers_link" target="dealers"/>
		<link name="docs_link" target="docs"/>
		<link name="contacts_link" target="contacts"/>
		<link name="cart_ajax_link" target="cart_ajax"/>
		<link name="cart_link" target="cart"/>
		<link name="search_link" target="search"/>
		<link name="feedback_form_link" target="feedback_ajax"/>
		<link name="fav_ajax_link" target="fav_ajax"/>
		<link name="compare_ajax_link" target="compare_ajax"/>
		<link name="register_link" target="register"/>
		<link name="login_form_link" target="login_form_ajax"/>
		<link name="personal_ajax_link" target="personal_ajax"/>
	</include-definition>


	<page name="index" template="index" cacheable="false">
		<single item="main_page" cacheable="true">
			<list item="main_promo_bottom"/>
		</single>
		<single item="news">
			<list item="news_item" id="ni">
				<filter>
					<sorting direction="DESC"><var value="date"/></sorting>
					<limit><var value="4"/></limit>
				</filter>
				<link name="show_news_item" target="news_item" type="exclusive">
					<var name="ni" ref="ni" style="translit"/>
				</link>
			</list>
		</single>
		<include name="COMMON"/>
	</page>


	<page name="catalog" template="catalog" cacheable="true">
		<include name="COMMON"/>
	</page>


	<page name="section" template="section" cacheable="false" critical-item="cur_sec">
		<request>
			<var name="sec" style="translit"/>
			<var name="page" value="1"/>
			<var name="view" value="table" scope="cookie"/>
			<var name="limit" value="12" scope="cookie"/>
			<var name="minqty" scope="cookie"/>
			<var name="sort" scope="cookie"/>
			<var name="direction" value="ASC" scope="cookie"/>
			<var name="tag1"/>
			<var name="tag2_1"/>
			<var name="tag2_2"/>
			<var name="tag2_3"/>
			<var name="tag2_4"/>
			<var name="tag2_5"/>
		</request>
		<single item="section" var="sec" id="cur_sec" tag="current_section">
			<list item="product" assoc="contains" id="prod">
				<filter>
					<parameter name="qty" compare="ANY" sign="&gt;"><var var="minqty" /></parameter>
					<child item="tag_first">
						<parameter name="tag" compare="ANY"><var var="tag1"/></parameter>
					</child>
					<child item="tag_second" transit="true">
						<parameter name="name_value" compare="ANY"><var var="tag2_1"/></parameter>
					</child>
					<child item="tag_second" transit="true">
						<parameter name="name_value" compare="ANY"><var var="tag2_2"/></parameter>
					</child>
					<child item="tag_second" transit="true">
						<parameter name="name_value" compare="ANY"><var var="tag2_3"/></parameter>
					</child>
					<child item="tag_second" transit="true">
						<parameter name="name_value" compare="ANY"><var var="tag2_4"/></parameter>
					</child>
					<child item="tag_second" transit="true">
						<parameter name="name_value" compare="ANY"><var var="tag2_5"/></parameter>
					</child>
					<sorting direction-var="direction"><var var="sort"/></sorting>
					<limit><var var="limit"/></limit>
					<pages><var var="page"/></pages>
				</filter>
				<link name="show_product" target="product" type="exclusive">
					<var name="sec" ref="cur_sec" style="translit"/>
					<var name="prod" ref="prod" style="translit"/>
				</link>
				<link name="to_cart" target="cart_action">
					<var name="action" value="addToCart"/>
					<var name="code" ref="prod" parameter="code"/>
				</link>
				<link name="to_fav" target="cookie_list_action">
					<var name="update_cookie_name" value="favourites"/>
					<var name="update_cookie_value" ref="prod" parameter="code"/>
					<var name="action" value="add"/>
					<var name="src_page" value="fav_ajax"/>
				</link>
				<link name="to_compare" target="cookie_list_action">
					<var name="update_cookie_name" value="compare"/>
					<var name="update_cookie_value" ref="prod" parameter="code"/>
					<var name="action" value="add"/>
					<var name="src_page" value="compare_ajax"/>
				</link>
			</list>
			<list item="tag_first" id="tag_first" assoc="contains" transit="true">
				<aggregation parameter="tag"/>
				<link name="set_tag_1" target="section" type="exclusive">
					<var name="sec" var="sec" style="translit"/>
					<!--<var name="tag1" var="tag1"/> это был вторая переменная с названием tag1 -->
					<var name="tag1" ref="tag_first" parameter="tag"/>
				</link>
			</list>
			<list item="tag_second" id="tag_second" assoc="contains" transit="true">
				<filter>
					<parent item="tag_first">
						<parameter name="tag" compare="SOME"><var var="tag1"/></parameter>
					</parent>
				</filter>
				<ancestor item="tag_first"/>
			</list>
		</single>
		<link name="set_view_table" target="section" copy-page-vars="yes" type="exclusive">
			<var name="view" value="table"/>
		</link>
		<link name="set_view_list" target="section" copy-page-vars="yes" type="exclusive">
			<var name="view" value="list"/>
		</link>
		<link name="set_limit_12" target="section" copy-page-vars="yes" type="exclusive">
			<var name="limit" value="12"/>
		</link>
		<link name="set_limit_24" target="section" copy-page-vars="yes" type="exclusive">
			<var name="limit" value="24"/>
		</link>
		<link name="set_limit_all" target="section" copy-page-vars="yes" type="exclusive">
			<var name="limit" value="300"/>
		</link>
		<link name="filter_base_link" target="section" type="exclusive">
			<var name="sec" var="sec" style="translit"/>
			<var name="tag1" var="tag1"/>
		</link>
		<link name="remove_tag_link" target="section" type="exclusive">
			<var name="sec" var="sec" style="translit"/>
		</link>
		<link name="show_only_available" target="section" copy-page-vars="yes" type="exclusive">
			<var name="minqty" value="0"/>
		</link>
		<link name="show_all" target="section" copy-page-vars="yes" type="exclusive">
			<var name="minqty" value=""/>
		</link>
		<link name="set_sort_name_asc" target="section" copy-page-vars="yes" type="exclusive">
			<var name="sort" value="name"/>
			<var name="direction" value="ASC"/>
		</link>
		<link name="set_sort_name_desc" target="section" copy-page-vars="yes" type="exclusive">
			<var name="sort" value="name"/>
			<var name="direction" value="DESC"/>
		</link>
		<link name="set_sort_price_asc" target="section" copy-page-vars="yes" type="exclusive">
			<var name="sort" value="price"/>
			<var name="direction" value="ASC"/>
		</link>
		<link name="set_sort_price_desc" target="section" copy-page-vars="yes" type="exclusive">
			<var name="sort" value="price"/>
			<var name="direction" value="DESC"/>
		</link>
		<link name="set_sort_default" target="section" copy-page-vars="yes" type="exclusive">
			<var name="sort" value=""/>
			<var name="direction" value="ASC"/>
		</link>
		<include name="COMMON"/>
	</page>


	<page name="search" template="search">
		<request>
			<var name="q"/>
			<var name="view" value="table" scope="cookie"/>
			<var name="minqty" scope="cookie"/>
		</request>
		<list item="product" assoc="contains" id="prod">
			<filter>
				<fulltext limit="30" compare="EVERY"><var var="q"/></fulltext>
				<parameter name="qty" compare="ANY" sign="&gt;"><var var="minqty" /></parameter>
			</filter>
			<link name="show_product" target="product" type="exclusive">
				<var name="prod" ref="prod" style="translit"/>
			</link>
			<link name="to_cart" target="cart_action">
				<var name="action" value="addToCart"/>
				<var name="code" ref="prod" parameter="code"/>
			</link>
			<link name="to_fav" target="cookie_list_action">
				<var name="update_cookie_name" value="favourites"/>
				<var name="update_cookie_value" ref="prod" parameter="code"/>
				<var name="action" value="add"/>
				<var name="src_page" value="fav_ajax"/>
			</link>
			<link name="to_compare" target="cookie_list_action">
				<var name="update_cookie_name" value="compare"/>
				<var name="update_cookie_value" ref="prod" parameter="code"/>
				<var name="action" value="add"/>
				<var name="src_page" value="compare_ajax"/>
			</link>
		</list>
		<link name="set_view_table" target="search" copy-page-vars="yes">
			<var name="view" value="table"/>
		</link>
		<link name="set_view_list" target="search" copy-page-vars="yes">
			<var name="view" value="list"/>
		</link>
		<link name="show_only_available" target="search">
			<var name="q" var="q"/>
			<var name="minqty" value="0"/>
		</link>
		<link name="show_all" target="search">
			<var name="q" var="q"/>
			<var name="minqty" value=""/>
		</link>
		<include name="COMMON"/>
	</page>



	<page name="product" template="product" cacheable="true" critical-item="prod">
		<request>
			<var name="sec" style="translit"/>
			<var name="prod" style="translit"/>
		</request>
		<single item="product" id="prod" var="prod">
			<ancestor item="section" assoc="contains" transit="false" tag="product_section"/>
			<link name="to_cart" target="cart_action">
				<var name="action" value="addToCart"/>
				<var name="code" ref="prod" parameter="code"/>
			</link>
			<link name="to_fav" target="cookie_list_action">
				<var name="update_cookie_name" value="favourites"/>
				<var name="update_cookie_value" ref="prod" parameter="code"/>
				<var name="action" value="add"/>
				<var name="src_page" value="fav_ajax"/>
			</link>
			<link name="to_compare" target="cookie_list_action">
				<var name="update_cookie_name" value="compare"/>
				<var name="update_cookie_value" ref="prod" parameter="code"/>
				<var name="action" value="add"/>
				<var name="src_page" value="compare_ajax"/>
			</link>
		</single>
		<list item="product" id="acc" tag="accessory">
			<filter>
				<parameter name="code" compare="SOME"><var ref="prod" parameter="accessiories"/></parameter>
			</filter>
			<link name="show_product" target="product" type="exclusive">
				<var name="prod" ref="acc" style="translit"/>
			</link>
			<link name="to_cart" target="cart_action">
				<var name="action" value="addToCart"/>
				<var name="code" ref="acc" parameter="code"/>
			</link>
		</list>
		<list item="product" id="set" tag="set">
			<filter>
				<parameter name="code" compare="SOME"><var ref="prod" parameter="sets"/></parameter>
			</filter>
			<link name="show_product" target="product" type="exclusive">
				<var name="prod" ref="set" style="translit"/>
			</link>
			<link name="to_cart" target="cart_action">
				<var name="action" value="addToCart"/>
				<var name="code" ref="set" parameter="code"/>
			</link>
		</list>
		<list item="product" id="probe" tag="probe">
			<filter>
				<parameter name="code" compare="SOME"><var ref="prod" parameter="probes"/></parameter>
			</filter>
			<link name="show_product" target="product" type="exclusive">
				<var name="prod" ref="probe" style="translit"/>
			</link>
			<link name="to_cart" target="cart_action">
				<var name="action" value="addToCart"/>
				<var name="code" ref="probe" parameter="code"/>
			</link>
		</list>
		<single item="section" var="sec" tag="current_section"/>
		<include name="COMMON"/>
	</page>



	<page name="news" template="news" cacheable="true">
		<request>
			<var name="p" value="1"/>
		</request>
		<single item="news">
			<list item="news_item" id="ni">
				<filter>
					<sorting direction="DESC"><var value="date"/></sorting>
					<limit><var value="12"/></limit>
					<pages><var var="p"/></pages>
				</filter>
				<link name="show_news_item" target="news_item" type="exclusive">
					<var name="ni" ref="ni" style="translit"/>
				</link>
			</list>
		</single>
		<include name="COMMON"/>
	</page>


	<page name="articles" template="news" cacheable="true">
		<request>
			<var name="p" value="1"/>
		</request>
		<single item="articles">
			<list item="news_item" id="ni">
				<filter>
					<sorting direction="DESC"><var value="date"/></sorting>
					<limit><var value="12"/></limit>
					<pages><var var="p"/></pages>
				</filter>
				<link name="show_news_item" target="news_item" type="exclusive">
					<var name="ni" ref="ni" style="translit"/>
				</link>
			</list>
		</single>
		<include name="COMMON"/>
	</page>


	<page name="news_item" template="news_item" cacheable="true">
		<request>
			<var name="ni" style="translit"/>
		</request>
		<single item="news_item" var="ni" cacheable="true" cache-vars="ni">
			<ancestor item="news"/>
			<ancestor item="articles"/>
		</single>
		<include name="COMMON"/>
	</page>



	<page name="dealers" template="dealers" cacheable="true">
		<list item="dealer_coords" cacheable="true"/>
		<include name="COMMON"/>
	</page>


	<page name="docs" template="docs" cacheable="true">
		<single item="docs" cacheable="true"/>
		<include name="COMMON"/>
	</page>


	<page name="contacts" template="contacts" cacheable="true">
		<single item="contacts" cacheable="true"/>
		<include name="COMMON"/>
	</page>


	<page name="update_prices" template="update_prices">
		<command class="extra.UpdatePrices" clear-cache="yes">
			<result name="complete" type="xml"/>
		</command>
	</page>


	<page name="page" cacheable="true" template="page">
		<request>
			<var name="p" style="translit"/>
		</request>
		<single item="custom_page" var="p" cacheable="true"/>
		<include name="COMMON"/>
	</page>


	<page name="feedback_ajax" template="feedback_ajax">
		<request>
			<var name="result"/>
			<var name="message"/>
		</request>
		<new item="feedback_form" id="form">
			<parameter-input ref="form" form="feedback"/>
		</new>
		<link name="submit_link" target="feedback_command" type="itemform">
			<var name="form_name" value="feedback"/>
			<var name="source_page" value="feedback_ajax"/>
		</link>
	</page>



	<page name="feedback_command">
		<request>
			<var name="topic" value="Обратная связь"/>
			<var name="email" value="forever@forever-ds.com"/>
			<var name="form_name"/>
			<var name="source_page"/>
			<var name="required" value="phone|email, message"/>
		</request>
		<link name="success" target-var="source_page">
			<var name="result" value="success"/>
			<var name="message" value="Сообщение успешно отправлено, спасибо"/>
		</link>
		<link name="error_not_set" target-var="source_page">
			<var name="result" value="error"/>
			<var name="message" value="Заполните, пожалуйста, обязательные поля"/>
		</link>
		<link name="general_error" target-var="source_page">
			<var name="result" value="error"/>
			<var name="message" value="Сообщение не может быть отправлено сейчас из-за ошибки сервера. Пожалуйста, попробуйте позже."/>
		</link>
		<command class="ecommander.fwk.NonemptyEmailCommand">
			<result name="success" type="redirect"/>
			<result name="error_not_set" type="redirect"/>
			<result name="general_error" type="redirect"/>
		</command>
	</page>



	<!--///////////////////////////////////////////////////////////////////////////////////////////////-->
	<!--/////////////                                                                      ////////////-->
	<!--/////////////                  КОРЗИНА, СРАВНЕНИЕ, ИЗБРАННОЕ                       ////////////-->
	<!--/////////////                                                                      ////////////-->
	<!--///////////////////////////////////////////////////////////////////////////////////////////////-->


	<page name="cart_ajax" template="cart_ajax">
		<request>
			<var name="cart_cookie" scope="cookie"/>
		</request>
		<headers Cache-Control="no-cache" Expires="-1"/>
		<command class="extra.CartManageCommand" method="restoreFromCookie"/>
		<session>
			<single item="cart">
				<list item="bought">
					<list item="product" id="product">
						<link name="to_cart" target="cart_action">
							<var name="action" value="addToCart"/>
							<var name="code" ref="product" parameter="code"/>
						</link>
					</list>
				</list>
			</single>
		</session>
		<link name="show_cart" target="cart"/>
	</page>


	<page name="cart_action">
		<request>
			<var name="action"/>
			<var name="code"/>
			<var name="qty"/>
			<var name="email" value="egor@forever-ds.com"/>
			<var name="cart_cookie" scope="cookie"/>
		</request>
		<link name="ajax" target="cart_ajax"/>
		<link name="cart" target="cart"/>
		<link name="proceed" target="proceed"/>
		<link name="confirm" target="confirm"/>
		<link name="validation_failed" target="proceed">
			<var name="message" value="Заполните, пожалуйста, обязательные поля формы"/>
		</link>
		<link name="email_send_failed" target="proceed"/>
		<command class="extra.CartManageCommand" method-var="action">
			<result name="ajax" type="redirect"/>
			<result name="cart" type="redirect"/>
			<result name="proceed" type="redirect"/>
			<result name="confirm" type="redirect"/>
			<result name="validation_failed" type="redirect"/>
			<result name="email_send_failed" type="redirect"/>
		</command>
	</page>



	<page name="cart" template="cart">
		<request>
			<var name="cart_cookie" scope="cookie"/>
		</request>
		<command class="extra.CartManageCommand" method="restoreFromCookie"/>
		<session>
			<single item="cart" id="cart">
				<list item="bought" id="bought">
					<list item="product" id="prod" tag="product">
						<link name="show_product" target="product" type="exclusive">
							<var name="prod" ref="prod" style="translit"/>
						</link>
					</list>
					<link name="delete" target="cart_action">
						<var name="action" value="delete"/>
						<var name="bought" ref="bought"/>
					</link>
					<parameter-input ref="bought" name="qty"/>
				</list>
			</single>
		</session>
		<link name="recalculate_link" target="cart_action" type="itemform">
			<var name="action" value="recalculate"/>
		</link>
		<link name="proceed_link" target="cart_action" type="itemform">
			<var name="action" value="proceed"/>
		</link>
		<include name="COMMON"/>
	</page>



	<page name="proceed" template="proceed">
		<request>
			<var name="message"/>
		</request>
		<new item="user_phys" id="user_phys" tag="phys_form">
			<parameter-input ref="user_phys" form="customer_phys"/>
		</new>
		<new item="user_jur" id="user_jur" tag="jur_form">
			<parameter-input ref="user_jur" form="customer_jur"/>
		</new>
		<link name="confirm_link" target="cart_action" type="itemform">
			<var name="action" value="customerForm"/>
		</link>
		<session>
			<single item="user" id="user">
				<parameter-input ref="user" form="customer"/>
			</single>
		</session>
		<include name="COMMON"/>
	</page>



	<page name="confirm" template="confirm">
		<request>
			<var name="message"/>
		</request>
		<session>
			<single item="user"/>
			<single item="cart">
				<list item="bought">
					<list item="product" tag="product"/>
				</list>
			</single>
		</session>
		<link name="confirm_link" target="cart_action" type="itemform">
			<var name="action" value="confirm"/>
		</link>
		<include name="COMMON"/>
	</page>



	<page name="order_email" template="order_email">
		<session>
			<single item="user"/>
			<single item="cart">
				<list item="bought">
					<list item="product" tag="product"/>
				</list>
			</single>
		</session>
		<include name="COMMON"/>
	</page>



	<page name="fav_ajax" template="fav_ajax">
		<request>
			<var name="favourites" scope="cookie"/>
		</request>
		<headers Cache-Control="no-cache" Expires="-1"/>
		<list item="product" id="prod">
			<filter>
				<parameter name="code" compare="SOME"><var var="favourites"/></parameter>
			</filter>
			<link name="from_fav" target="cookie_list_action">
				<var name="update_cookie_name" value="favourites"/>
				<var name="update_cookie_value" ref="prod" parameter="code"/>
				<var name="action" value="remove"/>
				<var name="src_page" value="fav_ajax"/>
			</link>
		</list>
		<link name="fav_link" target="fav"/>
	</page>



	<page name="compare_ajax" template="compare_ajax">
		<request>
			<var name="compare" scope="cookie"/>
		</request>
		<headers Cache-Control="no-cache" Expires="-1"/>
		<list item="product" id="prod">
			<filter>
				<parameter name="code" compare="SOME"><var var="compare"/></parameter>
			</filter>
			<link name="from_compare" target="cookie_list_action">
				<var name="update_cookie_name" value="compare"/>
				<var name="update_cookie_value" ref="prod" parameter="code"/>
				<var name="action" value="remove"/>
				<var name="src_page" value="compare_ajax"/>
			</link>
		</list>
		<link name="compare_link" target="compare"/>
	</page>


	<page name="cookie_list_action">
		<request>
			<var name="action"/>
			<var name="update_cookie_name"/>
			<var name="update_cookie_value"/>
			<var name="src_page"/>
		</request>
		<link name="success" target-var="src_page"/>
		<command class="ecommander.fwk.CookieArrayCommand" method-var="action">
			<result name="success" type="redirect"/>
		</command>
	</page>


	<page name="fav" template="fav">
		<request>
			<var name="favourites" scope="cookie"/>
		</request>
		<list item="product" id="prod">
			<filter>
				<parameter name="code" compare="SOME"><var var="favourites"/></parameter>
			</filter>
			<link name="from_fav" target="cookie_list_action">
				<var name="update_cookie_name" value="favourites"/>
				<var name="update_cookie_value" ref="prod" parameter="code"/>
				<var name="action" value="remove"/>
				<var name="src_page" value="fav"/>
			</link>
			<link name="to_cart" target="cart_action">
				<var name="action" value="addToCart"/>
				<var name="code" ref="prod" parameter="code"/>
			</link>
			<link name="to_compare" target="cookie_list_action">
				<var name="update_cookie_name" value="compare"/>
				<var name="update_cookie_value" ref="prod" parameter="code"/>
				<var name="action" value="add"/>
				<var name="src_page" value="compare_ajax"/>
			</link>
			<link name="show_product" target="product" type="exclusive">
				<var name="prod" ref="prod" style="translit"/>
			</link>
		</list>
		<link name="set_view_table" target="fav">
			<var name="view" value="table"/>
		</link>
		<link name="set_view_list" target="fav">
			<var name="view" value="list"/>
		</link>
		<include name="COMMON"/>
	</page>



	<page name="compare" template="compare">
		<request>
			<var name="compare" scope="cookie"/>
		</request>
		<list item="product" id="prod">
			<filter>
				<parameter name="code" compare="SOME"><var var="compare"/></parameter>
			</filter>
			<link name="from_compare" target="cookie_list_action">
				<var name="update_cookie_name" value="compare"/>
				<var name="update_cookie_value" ref="prod" parameter="code"/>
				<var name="action" value="remove"/>
				<var name="src_page" value="compare"/>
			</link>
			<link name="show_product" target="product" type="exclusive">
				<var name="prod" ref="prod" style="translit"/>
			</link>
			<link name="to_cart" target="cart_action">
				<var name="action" value="addToCart"/>
				<var name="code" ref="prod" parameter="code"/>
			</link>
		</list>
		<include name="COMMON"/>
	</page>



	<!--///////////////////////////////////////////////////////////////////////////////////////////////-->
	<!--/////////////                                                                      ////////////-->
	<!--/////////////                            РЕГИСТРАЦИЯ                               ////////////-->
	<!--/////////////                                                                      ////////////-->
	<!--///////////////////////////////////////////////////////////////////////////////////////////////-->




	<page name="register" template="register">
		<request>
			<var name="message"/>
			<var name="success" />
		</request>
		<new item="user_phys" id="user_phys">
			<parameter-input ref="user_phys" form="register"/>
		</new>
		<new item="user_jur" id="user_jur">
			<parameter-input ref="user_jur" form="register"/>
		</new>
		<link name="confirm_link" target="register_action" type="itemform">
			<var name="action" value="register"/>
		</link>
		<include name="COMMON"/>
	</page>


	<page name="register_action">
		<request>
			<var name="action"/>
		</request>
		<link name="not_set" target="register">
			<var name="message" value="Заполните, пожалуйста, обязательные поля формы"/>
		</link>
		<link name="user_exists" target="register">
			<var name="message" value="Пользователь с таким логином уже существует. Введите, пожалуйста, другой логин"/>
		</link>
		<link name="success" target="register">
			<var name="message" value="Вы успешно зарегистрированы, спасибо"/>
			<var name="success" value="true"/>
		</link>
		<link name="login" target="login_form_ajax">
			<var name="success" value="true"/>
		</link>
		<link name="login_error" target="login_form_ajax">
			<var name="message" value="Неверные логин/пароль"/>
			<var name="success" value="false"/>
		</link>
		<link name="passwords_not_match_error" target="personal">
			<var name="message" value="Пароль и подтверждение не совпадают"/>
			<var name="success" value="false"/>
		</link>
		<link name="success_personal" target="personal">
			<var name="message" value="Изменения учетной записи сохранены"/>
			<var name="success" value="true"/>
		</link>
		<link name="not_set_personal" target="personal">
			<var name="message" value="Заполните, пожалуйста, обязательные поля формы"/>
		</link>
		<link name="user_exists_personal" target="personal">
			<var name="message" value="Пользователь с таким логином уже существует. Введите, пожалуйста, другой логин"/>
		</link>
		<command class="extra.RegisterCommand" method-var="action">
			<result name="not_set" type="redirect"/>
			<result name="user_exists" type="redirect"/>
			<result name="success" type="redirect"/>
			<result name="passwords_not_match_error" type="redirect"/>
			<result name="success_personal" type="redirect"/>
			<result name="not_set_personal" type="redirect"/>
			<result name="user_exists_personal" type="redirect"/>
		</command>
	</page>


	<page name="login_action">
		<request>
			<var name="username"/>
			<var name="password"/>
			<var name="action"/>
			<var name="url"/>
		</request>
		<link name="not_correct" target="login_form_ajax">
			<var name="message" value="Неверные логин/пароль"/>
			<var name="success" value="false"/>
		</link>
		<link name="error" target="login_form_ajax">
			<var name="message" value="Действие временно недоступно, попробуйте позже"/>
			<var name="success" value="false"/>
		</link>
		<link name="out" target="login_form_ajax">
			<var name="success" value="true"/>
			<var name="target" value="index"/>
		</link>
		<link name="registered" target="login_form_ajax">
			<var name="success" value="true"/>
		</link>
		<link name="manager" target="login_form_ajax">
			<var name="success" value="true"/>
			<var name="target" value="orders"/>
		</link>
		<command class="ecommander.fwk.LoginCommand">
			<result name="not_correct" type="redirect"/>
			<result name="error" type="redirect"/>
			<result name="out" type="redirect"/>
			<result name="registered" type="redirect"/>
			<result name="manager" type="redirect"/>
		</command>
	</page>


	<page name="test"/>


	<page name="login_form_ajax" template="login_form_ajax">
		<request>
			<var name="message"/>
		</request>
		<link name="submit_form" target="register_action">
			<var name="action" value="login"/>
		</link>
		<link name="login_link" target="login_action"/>
	</page>


	<page name="personal_ajax" template="personal_ajax">
		<link name="personal_link" target="personal"/>
		<link name="purchase_history_link" target="purchase_history"/>
		<link name="register_link" target="register"/>
	</page>


	<page name="personal" template="personal" authority-groups="registered">
		<personal>
			<single item="user" id="user">
				<parameter-input ref="user"/>
				<extra-input name="new-password-1" ref="user"/>
				<extra-input name="new-password-2" ref="user"/>
				<link name="confirm_link" target="register_action" type="itemform">
					<var name="action" value="update"/>
				</link>
			</single>
		</personal>
		<include name="COMMON"/>
	</page>


	<page name="purchase_history" template="purchase_history" authority-groups="registered">
		<personal>
			<list item="purchase">
				<filter>
					<sorting direction="DESC"><var value="date"/></sorting>
				</filter>
				<list item="bought" id="bought"/>
			</list>
		</personal>
		<list item="product" id="prod">
			<filter>
				<parameter name="code" compare="SOME"><var ref="bought" parameter="code"/></parameter>
			</filter>
			<link name="show_product" target="product">
				<var name="prod" ref="prod" style="translit"/>
			</link>
			<link name="to_cart" target="cart_action">
				<var name="action" value="addToCart"/>
				<var name="code" ref="prod" parameter="code"/>
			</link>
			<link name="to_fav" target="cookie_list_action">
				<var name="update_cookie_name" value="favourites"/>
				<var name="update_cookie_value" ref="prod" parameter="code"/>
				<var name="action" value="add"/>
				<var name="src_page" value="fav_ajax"/>
			</link>
			<link name="to_compare" target="cookie_list_action">
				<var name="update_cookie_name" value="compare"/>
				<var name="update_cookie_value" ref="prod" parameter="code"/>
				<var name="action" value="add"/>
				<var name="src_page" value="compare_ajax"/>
			</link>
		</list>
		<include name="COMMON"/>
	</page>



	<!--///////////////////////////////////////////////////////////////////////////////////////////////-->
	<!--/////////////                                                                      ////////////-->
	<!--/////////////                        ЗАКАЗЫ И МЕНЕДЖЕРЫ                            ////////////-->
	<!--/////////////                                                                      ////////////-->
	<!--///////////////////////////////////////////////////////////////////////////////////////////////-->



	<include-definition name="MANAGER_COMMON">
		<link name="orders_link" target="orders"/>
		<link name="users_link" target="users"/>
		<link name="orders_all_link" target="orders_all"/>
		<link name="users_all_link" target="users_all"/>
		<link name="logout_link" target="login_action">
			<var name="action" value="out"/>
		</link>
	</include-definition>


	<page name="orders_all" template="manager/orders" authority-groups="common">
		<request>
			<var name="message"/>
			<var name="success"/>
			<var name="u"/>
		</request>
		<single item="user" var="u" id="pred"/>
		<list item="purchase" id="purchase">
			<filter>
				<predecessor ref="pred" compare="ANY"/>
				<sorting direction="ASC"><var value="status"/></sorting>
				<sorting direction="DESC"><var value="date"/></sorting>
			</filter>
			<ancestor item="user" tag="user"/>
			<ancestor item="manager" assoc="manages" transit="true"/>
			<link name="show_purchase" target="order">
				<var name="p" ref="purchase"/>
			</link>
			<link name="set_manager" target="manage_purchase">
				<var name="p" ref="purchase"/>
				<var name="src_page" value="orders_all"/>
			</link>
		</list>
		<list item="manager"/>
		<include name="MANAGER_COMMON"/>
	</page>


	<page name="users_all" template="manager/users" authority-groups="common">
		<request>
			<var name="message"/>
			<var name="success"/>
		</request>
		<list item="user" id="user">
			<ancestor item="manager" assoc="manages" transit="false"/>
			<link name="set_manager" target="manage_purchase">
				<var name="u" ref="user"/>
				<var name="src_page" value="users_all"/>
			</link>
			<link name="show_orders" target="orders_all">
				<var name="u" ref="user"/>
			</link>
		</list>
		<list item="manager"/>
		<include name="MANAGER_COMMON"/>
	</page>


	<page name="orders" template="manager/orders" authority-groups="manager">
		<request>
			<var name="message"/>
			<var name="success"/>
			<var name="u"/>
		</request>
		<single item="user" var="u" id="pred"/>
		<personal>
			<single item="manager">
				<usergroup name="registered">
					<list item="purchase" id="purchase" transit="true" assoc="manages">
						<filter>
							<predecessor ref="pred" compare="ANY"/>
							<sorting direction="ASC"><var value="status"/></sorting>
							<sorting direction="DESC"><var value="date"/></sorting>
						</filter>
						<ancestor item="user" tag="user"/>
						<link name="show_purchase" target="order">
							<var name="p" ref="purchase"/>
						</link>
						<link name="set_manager" target="manage_purchase">
							<var name="p" ref="purchase"/>
							<var name="src_page" value="orders"/>
						</link>
					</list>
				</usergroup>
			</single>
		</personal>
		<include name="MANAGER_COMMON"/>
	</page>


	<page name="users" template="manager/users" authority-groups="manager">
		<request>
			<var name="message"/>
			<var name="success"/>
		</request>
		<personal>
			<single item="manager">
				<usergroup name="registered">
					<list item="user" id="user" assoc="manages">
						<ancestor item="manager" assoc="manages" transit="false"/>
						<link name="set_manager" target="manage_purchase">
							<var name="u" ref="user"/>
							<var name="src_page" value="users"/>
						</link>
						<link name="show_orders" target="orders">
							<var name="u" ref="user"/>
						</link>
					</list>
				</usergroup>
			</single>
		</personal>
		<include name="MANAGER_COMMON"/>
	</page>



	<page name="order" template="manager/order" authority-groups="manager">
		<request>
			<var name="p"/>
		</request>
		<single item="purchase" var="p">
			<list item="bought" id="bought"/>
			<ancestor item="user" tag="user"/>
		</single>
		<list item="product" id="prod">
			<filter>
				<parameter name="code" compare="SOME"><var ref="bought" parameter="code" /></parameter>
			</filter>
			<ancestor item="section" id="sec" assoc="contains">
				<link name="show_product" target="product" type="exclusive">
					<var name="sec" ref="sec" style="translit"/>
					<var name="prod" ref="prod" style="translit"/>
				</link>
			</ancestor>
		</list>
		<link name="set_status" target="manage_purchase">
			<var name="p" var="p"/>
			<var name="src_page" value="order"/>
		</link>
		<include name="MANAGER_COMMON"/>
	</page>



	<page name="manage_purchase" authority-groups="manager">
		<request>
			<var name="p"/>
			<var name="status"/>
			<var name="manager"/>
			<var name="src_page"/>
		</request>
		<link name="success" target-var="src_page">
			<var name="p" var="p"/>
			<var name="success" value="true"/>
		</link>
		<link name="error" target-var="src_page">
			<var name="p" var="p"/>
			<var name="success" value="false"/>
		</link>
		<command class="extra.ManagePurchase">
			<result name="success" type="redirect"/>
			<result name="error" type="redirect"/>
		</command>
	</page>








	<!--///////////////////////////////////////////////////////////////////////////////////////////////-->
	<!--/////////////                                                                      ////////////-->
	<!--/////////////                             ПАРСИНГ                                  ////////////-->
	<!--/////////////                                                                      ////////////-->
	<!--///////////////////////////////////////////////////////////////////////////////////////////////-->

	<!--//                                                                                                  -->
	<!--// Команда для получения HTML, его преобразования и скачивания файлов (в зависимости от параметров) -->
	<!--//                                                                                                  -->
	<page name="get_site" template="get_site" authority-groups="common">
		<request>
			<var name="action"/>
			<var name="stage" value="INIT"/>
		</request>
		<command class="lunacrawler.SingleCrawlerCommand" clear-cache="no">
			<result name="complete" type="xml"/>
		</command>
	</page>

	<!--//                                                                                                  -->
	<!--// Тестовая страница для проверки XSLT преобразования (ссылка берется из айтема parse_item в CMS)   -->
	<!--//                                                                                                  -->
	<page name="test_parse_item">
		<request>
			<var name="url"/>
		</request>
		<command class="lunacrawler.CrawlCommand" method="test">
			<result name="test_xsl" type="xml"/>
		</command>
	</page>

	<!--//                                                                          -->
	<!--// Интеграция полученных данных, хранящихся в айтемах parse_item на сайт    -->
	<!--//                                                                          -->
	<!--
	<page name="deploy_parsed" template="deploy_parsed" authority-groups="common">
		<request>
			<var name="action"/>
		</request>
		<list item="section" id="sec">
			<list item="parse_item" id="pi"/>
		</list>
		<command class="extra.DeployParsed" clear-cache="yes">
			<result name="complete" type="xml"/>
		</command>
	</page>
	-->
</site>