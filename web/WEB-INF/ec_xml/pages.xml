<?xml version="1.0" encoding="UTF-8"?>
<site>

<!-- ******************************* Включение для разделов каталога ****************************** -->

	<include-definition name="COMMON">
		<single item="catalog" id="catalog_main" cacheable="true">
			<tree item="section" id="sec">
				<link name="show_section" target="section" type="exclusive">
					<var name="sec" item="sec" style="translit"/>
				</link>
			</tree>
		</single>
		<link name="index_link" target="index"/>
		<link name="catalog_link" target="catalog"/>
	</include-definition>


	<page name="index" template="index" cacheable="true">
		<include name="COMMON"/>
	</page>


	<page name="catalog" template="catalog" cacheable="true">
		<include name="COMMON"/>
	</page>


	<page name="section" template="" cacheable="false">
		<request>
			<var name="sec" style="translit"/>
			<var name="page" value="1"/>
			<var name="view" value="table" scope="cookie"/>
			<var name="limit" value="12" scope="cookie"/>
			<var name="tag1"/>
			<var name="tag2"/>
		</request>
		<single item="section" var="sec" id="cur_sec" tag="current_section">
			<list item="product" assoc="contains" id="prod">
				<filter>
					<child item="tag_first">
						<parameter name="tag" compare="ANY"><var var="tag1"/></parameter>
						<child item="tag_second">
							<parameter name="name_value" compare="ANY"><var var="tag2"/></parameter>
						</child>
					</child>
					<limit><var var="limit"/></limit>
					<pages><var var="page"/></pages>
				</filter>
				<link name="show_product" target="product" type="exclusive">
					<var name="prod" item="prod" style="translit"/>
					<var name="sec" item="cur_sec" style="translit"/>
				</link>
			</list>
			<list item="tag_first" id="tag_first" assoc="contains" transit="true">
				<aggregation parameter="tag"/>
				<link name="set_tag_1" target="section" type="exclusive">
					<var name="sec" var="sec" style="translit"/>
					<var name="tag1" var="tag1"/>
					<var name="tag1" item="tag_first" parameter="tag"/>
				</link>
			</list>
			<list item="tag_second" id="tag_second" assoc="contains" transit="true">
				<filter>
					<parent item="tag_first">
						<parameter name="tag" compare="SOME"><var var="tag1"/></parameter>
					</parent>
				</filter>
				<link name="set_tag_2" target="section" type="exclusive">
					<var name="sec" var="sec" style="translit"/>
					<var name="tag1" var="tag1"/>
					<var name="tag2" var="tag2"/>
					<var name="tag2" item="tag_second" parameter="name_value"/>
				</link>
				<ancestor item="tag_first"/>
			</list>
		</single>
		<link name="set_view_table" target="section" copy-page-vars="yes" type="exclusive">
			<var name="view" value="table"/>
		</link>
		<link name="set_view_list" target="section" copy-page-vars="yes" type="exclusive">
			<var name="view" value="list"/>
		</link>
		<link name="set_limit_12" target="section" copy-page-vars="yes" type="exclusive">
			<var name="limit" value="12"/>
		</link>
		<link name="set_limit_24" target="section" copy-page-vars="yes" type="exclusive">
			<var name="limit" value="24"/>
		</link>
		<link name="set_limit_all" target="section" copy-page-vars="yes" type="exclusive">
			<var name="limit" value="10000"/>
		</link>
		<include name="COMMON"/>
	</page>


	<page name="product" template="product" cacheable="true">
		<request>
			<var name="prod" style="translit"/>
			<var name="sec" style="translit"/>
		</request>
		<single item="product" id="prod" var="prod">
			<ancestor item="section" assoc="contains" transit="false" tag="product_section"/>
		</single>
		<list item="product" id="acc" tag="accessory">
			<filter>
				<parameter name="code" compare="SOME"><var item="prod" parameter="accessiories"/></parameter>
			</filter>
			<link name="show_product" target="product">
				<var name="prod" item="acc" style="translit"/>
			</link>
		</list>
		<list item="product" id="set" tag="set">
			<filter>
				<parameter name="code" compare="SOME"><var item="prod" parameter="sets"/></parameter>
			</filter>
			<link name="show_product" target="product">
				<var name="prod" item="set" style="translit"/>
			</link>
		</list>
		<list item="product" id="probe" tag="probe">
			<filter>
				<parameter name="code" compare="SOME"><var item="prod" parameter="probes"/></parameter>
			</filter>
			<link name="show_product" target="product">
				<var name="prod" item="probe" style="translit"/>
			</link>
		</list>
		<single item="section" var="sec" tag="current_section"/>
		<include name="COMMON"/>
	</page>


	<page name="downloaded">
		<list item="parse_item" tag="NEW">
			<filter>
				<parameter name="duplicated"><var value="0"/></parameter>
				<limit><var value="0"/></limit>
			</filter>
		</list>
		<list item="parse_item" tag="DUPLICATED">
			<filter>
				<parameter name="duplicated"><var value="1"/></parameter>
			</filter>
		</list>
	</page>


	<!--///////////////////////////////////////////////////////////////////////////////////////////////-->
	<!--/////////////                                                                      ////////////-->
	<!--/////////////                             ПАРСИНГ                                  ////////////-->
	<!--/////////////                                                                      ////////////-->
	<!--///////////////////////////////////////////////////////////////////////////////////////////////-->

	<!--//                                                                                                  -->
	<!--// Команда для получения HTML, его преобразования и скачивания файлов (в зависимости от параметров) -->
	<!--//                                                                                                  -->
	<page name="get_site" template="get_site" authority-groups="common">
		<request>
			<var name="action"/>
			<var name="stage" value="INIT"/>
		</request>
		<command class="lunacrawler.SingleCrawlerCommand" clear-cache="no">
			<result name="complete" type="xml"/>
		</command>
	</page>

	<!--//                                                                                                  -->
	<!--// Тестовая страница для проверки XSLT преобразования (ссылка берется из айтема parse_item в CMS)   -->
	<!--//                                                                                                  -->
	<page name="test_parse_item">
		<request>
			<var name="pi"/>
		</request>
		<single item="parse_item" var="pi" id="pi"/>
		<command class="lunacrawler.TestParseItemCommand" clear-cache="no">
			<result name="test" type="xml"/>
		</command>
	</page>

	<!--//                                                                          -->
	<!--// Интеграция полученных данных, хранящихся в айтемах parse_item на сайт    -->
	<!--//                                                                          -->
	<page name="deploy_parsed" template="deploy_parsed" authority-groups="common">
		<request>
			<var name="action"/>
		</request>
		<list item="section" id="sec">
			<list item="parse_item" id="pi"/>
		</list>
		<command class="extra.DeployParsed" clear-cache="yes">
			<result name="complete" type="xml"/>
		</command>
	</page>
</site>