<?xml version="1.0" encoding="UTF-8"?>
<site>

	<!-- ******************************* Включение для разделов каталога ****************************** -->
	<include-definition name="COMMON">
		<link name="feedback_link" target="feedback_ajax"/>
		<link name="news_link" target="small_news"/>
		<!--<single item="custom_pages" id="custom_pages" cacheable="true">-->
			<!--<tree item="custom_page" id="custom_page" tag="menu_custom">-->
				<!--<link name="show_page" target="page" type="exclusive">-->
					<!--<var name="p" ref="custom_page" style="translit"/>-->
				<!--</link>-->
			<!--</tree>-->
		<!--</single>-->

		<list item="news" id="news" cacheable="true">
			<link name="show_page" target="news" type="exclusive">
				<var name="sel" ref="news" style="translit"/>
			</link>
		</list>

		<single item="common" cacheable="true">
			<list item="soc_link"/>
		</single>
		<link name="contacts_link" target="contacts"/>
		<link name="search_link" target="search"/>
		<link name="feedback_form_link" target="feedback_ajax"/>
		<single item="modules">
			<list item="named_code"/>
		</single>
		<single item="url_seo_wrap">
			<list item="url_seo"/>
		</single>
		<list item="news_item" tag="min">
			<aggregation parameter="date" function="min"/>
		</list>
		<list item="news_item" tag="max">
			<aggregation parameter="date" function="max"/>
		</list>
	</include-definition>


	<page name="index" template="index" cacheable="false">
		<request>
			<var name="limit" value="6"/>
			<var name="page" value="1"/>
		</request>
		<single item="main_page" id="main">
			<single item="seo"/>
			<list item="featured">
				<filter>
					<limit>
						<var value="3"/>
					</limit>
				</filter>
			</list>
		</single>
		<single item="news_wrap">
			<list item="news_item" id="ni" transit="true">
				<filter>
					<sorting direction="DESC">
						<var value="date"/>
					</sorting>
					<limit>
						<var var="limit"/>
					</limit>
					<pages>
						<var var="page"/>
					</pages>
					<parameter name="date" sign="&lt;=" compare="SOME">
						<var var="$now"/>
					</parameter>
				</filter>
				<single item="top_gal"/>
				<link name="show_page" target="news_item" type="exclusive">
					<var name="sel" ref="ni" style="translit"/>
				</link>
				<ancestor item="news" transit="false" id="cat">
					<link name="show_page" target="news" type="exclusive">
						<var name="sel" ref="cat" style="translit"/>
					</link>
				</ancestor>
			</list>
		</single>

		<list item="news_item" id="pni" tag="popular">
			<filter>
				<sorting direction="DESC">
					<var value="date"/>
				</sorting>
				<limit>
					<var value="12"/>
				</limit>
				<parameter name="date" sign="&lt;=" compare="SOME">
					<var var="$now"/>
				</parameter>
				<parameter name="popular" sign="=" compare="SOME">
					<var value="1"/>
				</parameter>
			</filter>
			<single item="top_gal"/>
			<link name="show_page" target="news_item" type="exclusive">
				<var name="sel" ref="pni" style="translit"/>
			</link>
			<ancestor item="news" transit="false" id="pcat">
				<link name="show_page" target="news" type="exclusive">
					<var name="sel" ref="pcat" style="translit"/>
				</link>
			</ancestor>
		</list>

		<list item="small_news_item" id="sni">
			<filter>
				<limit>
					<var value="5"/>
				</limit>
				<sorting direction="DESC">
					<var value="date"/>
				</sorting>
				<parameter name="date" sign="&lt;=" compare="SOME">
					<var var="$now"/>
				</parameter>
			</filter>
			<link name="show_page" target="small_news_item">
				<var name="sni" ref="sni" style="translit"/>
			</link>
		</list>

		<link name="load_more" target="news_ajax"/>
		<!--<list item="custom_page" tag="custom" id="article">-->
			<!--<link name="show_page" target="page" type="exclusive">-->
				<!--<var name="p" ref="article" style="translit"/>-->
			<!--</link>-->
		<!--</list>-->
		<include name="COMMON"/>
	</page>

	<page name="news_ajax" template="news_ajax">
		<request>
			<var name="limit" value="6"/>
			<var name="page" value="2"/>
		</request>
		<single item="news_wrap">
			<list item="news_item" id="ni" transit="true">
				<filter>
					<sorting direction="DESC">
						<var value="date"/>
					</sorting>
					<limit>
						<var var="limit"/>
					</limit>
					<pages>
						<var var="page"/>
					</pages>
					<parameter name="date" sign="&lt;=" compare="SOME">
						<var var="$now"/>
					</parameter>
				</filter>
				<single item="top_gal"/>
				<link name="show_page" target="news_item" type="exclusive">
					<var name="sel" ref="ni" style="translit"/>
				</link>
				<ancestor item="news" transit="false" id="cat">
					<link name="show_page" target="news" type="exclusive">
						<var name="sel" ref="cat" style="translit"/>
					</link>
				</ancestor>
			</list>
		</single>
		<link name="load_more" target="news_ajax"/>
	</page>

	<page name="search" template="search">
		<request>
			<var name="q"/>
		</request>
		<list item="searchable" id="prod">
			<filter>
				<fulltext limit="48" compare="EVERY">
					<var var="q"/>
				</fulltext>
			</filter>
			<!--<link name="show_cusotm_page" target="page" type="exclusive">-->
				<!--<var name="prod" ref="prod" style="translit"/>-->
			<!--</link>-->
			<link name="show_news_item" target="news_item" type="exclusive">
				<var name="ni" ref="prod" style="translit"/>
			</link>
			<link name="show_small_news_item" target="small_news_item" type="exclusive">
				<var name="sni" ref="prod" style="translit"/>
			</link>
			<ancestor item="news" transit="true" id="cat">
				<link name="show_page" target="news" type="exclusive">
					<var name="sel" ref="cat" style="translit"/>
				</link>
			</ancestor>
			<ancestor item="news_item" id="ni">
				<link name="show_page" target="news_item" type="exclusive">
					<var name="ni" ref="ni" style="translit"/>
				</link>
			</ancestor>
			<!--<ancestor item="custom_page" id="cp">-->
				<!--<link name="show_custom_page" target="page" type="exclusive">-->
					<!--<var name="prod" ref="cp" style="translit"/>-->
				<!--</link>-->
			<!--</ancestor>-->
		</list>
		<include name="COMMON"/>
	</page>

	<page name="news" template="news" cacheable="false">
		<request>
			<var name="sel" style="translit"/>
			<var name="p" value="1"/>
		</request>
		<single item="news" var="sel" tag="selected_news">
			<single item="seo"/>
			<list item="news_item" id="ni">
				<filter>
					<sorting direction="DESC">
						<var value="date"/>
					</sorting>
					<limit>
						<var value="6"/>
					</limit>
					<pages>
						<var name="p" var="p"/>
					</pages>
					<parameter name="date" sign="&lt;=" compare="SOME">
						<var var="$now"/>
					</parameter>
				</filter>
				<link name="show_page" target="news_item" type="exclusive">
					<var name="ni" ref="ni" style="translit"/>
				</link>
			</list>
		</single>
		<include name="COMMON"/>
	</page>

	<page name="all_news" template="all_news">
		<request>
			<var name="page" value="1"/>
			<var name="limit" value="6"/>
			<var name="tag" />
			<var name="min_date" />
			<var name="max_date" />
		</request>
		<single item="news_wrap">
			<list item="news_item" id="ni" transit="true">
				<filter>
					<parameter name="tag" sign="=">
						<var var="tag"/>
					</parameter>
					<parameter name="date" sign="&gt;=">
						<var var="min_date"/>
					</parameter>
					<parameter name="date" sign="&lt;=">
						<var var="max_date"/>
					</parameter>
					<sorting direction="DESC">
						<var value="date"/>
					</sorting>
					<limit>
						<var var="limit"/>
					</limit>
					<pages>
						<var var="page"/>
					</pages>
					<parameter name="date" sign="&lt;=" compare="SOME">
						<var var="$now"/>
					</parameter>
				</filter>
				<single item="top_gal"/>
				<link name="show_page" target="news_item" type="exclusive">
					<var name="sel" ref="ni" style="translit"/>
				</link>
				<ancestor item="news" transit="false" id="cat">
					<link name="show_page" target="news" type="exclusive">
						<var name="sel" ref="cat" style="translit"/>
					</link>
				</ancestor>
			</list>
		</single>
		<list item="news_item" id="tag" tag="tag">
			<aggregation parameter="tag" />
			<link name="show_tag" target="all_news">
				<var name="tag" ref="tag" parameter="tag"/>
			</link>
		</list>
		<include name="COMMON"/>
	</page>

	<page name="news_item" template="news_item" cacheable="false">
		<request>
			<var name="ni" style="translit"/>
		</request>
		<single item="news_item" var="ni" cacheable="false" cache-vars="ni">
			<single item="seo"/>
			<single item="top_gal"/>
			<single item="comments" id="comment">
				<tree item="comment"/>
				<link name="comment_link" target="comment_ajax">
					<var name="id" ref="comment"/>
					<var name="big_id" ref="comment"/>
				</link>
			</single>
			<ancestor item="news"/>
		</single>
		<include name="COMMON"/>
	</page>

	<page name="small_news" template="small_news">
		<request>
			<var name="page" value="1"/>
			<var name="limit" value="6"/>
			<var name="tag" />
			<var name="min_date" />
			<var name="max_date" />
		</request>
		<single item="small_news">
			<list item="small_news_item" id="ni">
				<filter>
					<parameter name="tag" sign="=">
						<var var="tag"/>
					</parameter>
					<parameter name="date" sign="&gt;=">
						<var var="min_date"/>
					</parameter>
					<parameter name="date" sign="&lt;=">
						<var var="max_date"/>
					</parameter>
					<sorting direction="DESC">
						<var value="date"/>
					</sorting>
					<limit>
						<var var="limit"/>
					</limit>
					<pages>
						<var var="page"/>
					</pages>
					<parameter name="date" sign="&lt;=" compare="SOME">
						<var var="$now"/>
					</parameter>
				</filter>
				<link name="show_page" target="small_news_item" type="exclusive">
					<var name="sni" ref="ni" style="translit" />
				</link>
			</list>
		</single>
		<list item="small_news_item" id="tag" tag="tag">
			<aggregation parameter="tag" />
			<link name="show_tag" target="small_news">
				<var name="tag" ref="tag" parameter="tag"/>
			</link>
		</list>
		<include name="COMMON"/>
	</page>

	<page name="small_news_item" template="small_news_item">
		<request>
			<var name="sni" style="translit"/>
		</request>
		<single item="small_news_item" var="sni" id="ni" cacheable="false" cache-vars="ni">
			<single item="seo"/>
		</single>
		<list item="small_news_item" tag="prev" id="prev" cacheable="false" cache-vars="ni">
			<filter>
				<limit>
					<var value="1"/>
				</limit>
				<parameter name="date" sign="&lt;" compare="SOME">
					<var ref="ni" parameter="date"/>
				</parameter>
				<sorting direction="DESC">
					<var value="date"/>
				</sorting>
			</filter>
			<link target="small_news_item" name="show_page">
				<var name="sni" style="translit" ref="prev" />
			</link>
		</list>
		<list item="small_news_item" tag="next" id="next" cacheable="false" cache-vars="ni">
			<filter>
				<limit>
					<var value="1"/>
				</limit>
				<parameter name="date" sign="&gt;" compare="SOME">
					<var ref="ni" parameter="date"/>
				</parameter>
				<sorting direction="ASC">
					<var value="date"/>
				</sorting>
			</filter>
			<link target="small_news_item" name="show_page">
				<var name="sni" style="translit" ref="next" />
			</link>
		</list>
		<include name="COMMON"/>
	</page>

	<!--<page name="page" template="page">-->
		<!--<request>-->
			<!--<var name="p" style="translit"/>-->
		<!--</request>-->
		<!--<single item="custom_page" var="p"/>-->
		<!--<include name="COMMON"/>-->
	<!--</page>-->


	<page name="contacts" template="contacts" cacheable="false">
		<single item="contacts" cacheable="false">
			<single item="seo"/>
		</single>
		<include name="COMMON"/>
	</page>

	<page name="feedback_ajax" template="feedback_ajax">
		<request>
			<var name="result"/>
			<var name="message"/>
		</request>
		<new item="feedback_form" id="form">
			<parameter-input ref="form" form="feedback"/>
		</new>
		<link name="submit_link" target="feedback_command" type="itemform">
			<var name="form_name" value="feedback"/>
			<var name="source_page" value="feedback_ajax"/>
		</link>
	</page>

	<page name="comment_ajax" template="comment_ajax">
		<request>
			<var name="id"/>
			<var name="big_id"/>
			<var name="result"/>
			<var name="message"/>
		</request>

		<single item="comments" var="big_id" id="comments">
			<tree item="comment"/>
			<link name="comment_link" target="comment_ajax">
				<var name="id" ref="comments"/>
				<var name="big_id" var="big_id"/>
			</link>
		</single>

		<new item="comment" id="form" tag="comment_form">
			<parameter-input ref="form" form="feedback"/>
		</new>
		<link name="submit_link" target="comments_command" type="itemform">
			<var name="big_id" var="big_id"/>
			<var name="form_name" value="feedback"/>
			<var name="source_page" value="comment_ajax"/>
		</link>
	</page>


	<page name="feedback_command">
		<request>
			<var name="topic" value="Обратная связь"/>
			<var name="email" value="bio@forever-ds.com"/>
			<var name="form_name"/>
			<var name="source_page"/>
			<var name="required" value="phone|email, message"/>
		</request>
		<link name="success" target-var="source_page">
			<var name="result" value="success"/>
			<var name="message" value="Сообщение успешно отправлено, спасибо"/>
		</link>
		<link name="error_not_set" target-var="source_page">
			<var name="result" value="error"/>
			<var name="message" value="Заполните, пожалуйста, все поля"/>
		</link>
		<link name="general_error" target-var="source_page">
			<var name="result" value="error"/>
			<var name="message"
				 value="Сообщение не может быть отправлено сейчас из-за ошибки сервера. Пожалуйста, попробуйте позже."/>
		</link>
		<command class="ecommander.fwk.NonemptyEmailCommand">
			<result name="success" type="redirect"/>
			<result name="error_not_set" type="redirect"/>
			<result name="general_error" type="redirect"/>
		</command>
	</page>

	<page name="comments_command">
		<request>
			<var name="big_id"/>
			<var name="id"/>
			<var name="source_page"/>
		</request>
		<link name="success" target-var="source_page">
			<var name="big_id" var="big_id"/>
			<var name="result" value="success"/>
			<var name="message" value="Комментарий отправлен, спасибо"/>
		</link>
		<link name="error_not_set" target-var="source_page">
			<var name="big_id" var="big_id"/>
			<var name="result" value="error"/>
			<var name="message" value="Заполните, пожалуйста, обязательные поля"/>
		</link>
		<link name="general_error" target-var="source_page">
			<var name="big_id" var="big_id"/>
			<var name="result" value="error"/>
			<var name="message"
				 value="Комментарий не может быть отправлен сейчас из-за ошибки сервера. Пожалуйста, попробуйте позже."/>
		</link>
		<command class="extra.CommentCommand">
			<result name="success" type="redirect"/>
			<result name="error_not_set" type="redirect"/>
			<result name="general_error" type="redirect"/>
		</command>
	</page>

	<!-- ГЕНЕРАЦИЯ КАРТЫ САЙТА -->
	<page name="sitemap" template="sitemap" cacheable="false">
		<headers content-type="xml"/>
		<single item="url_seo_wrap"/>

		<!--<list item="custom_page" id="custom_page" cacheable="false">-->
			<!--<link name="show_page" target="page" type="exclusive">-->
				<!--<var name="p" ref="custom_page" style="translit"/>-->
			<!--</link>-->
		<!--</list>-->
		<list item="news" id="news" cacheable="false">
			<link name="show_page" target="news" type="exclusive">
				<var name="sel" ref="news" style="translit"/>
			</link>
		</list>

		<link name="contacts_link" target="contacts"/>

		<list item="news_item" id="ni">
			<filter>
				<sorting direction="DESC">
					<var value="date"/>
				</sorting>
			</filter>
			<link name="show_news_item" target="news_item" type="exclusive">
				<var name="ni" ref="ni" style="translit"/>
			</link>

		</list>
	</page>

	<page name="generate_sitemap">
		<command class="ecommander.fwk.CreateSiteMap">
			<result name="complete" type="xml"/>
		</command>
	</page>


	<page name="delete_seo">
		<link name="success" target="delete_seo_complete">
			<var name="message" value="all OK. Seo is deleted"/>
		</link>
		<link name="error" target="delete_seo_complete"/>
		<command class="extra.ExterminateSEO">
			<result name="success" type="redirect"/>
			<result name="error" type="redirect"/>
		</command>
	</page>

	<page name="delete_seo_complete">
		<request>
			<var name="message"/>
		</request>
	</page>


</site>