<?xml version="1.0" encoding="UTF-8"?>
<site>

	<page name="index"></page>
	
	<!-- ********************************************************************* -->
	<!-- ********************************************************************* -->
	<!-- **************		ТОЛЬКО ДЛЯ ЛОКАЛЬНОГО САЙТА			************** -->
	<!-- ********************************************************************* -->
	<!-- ********************************************************************* -->

	<page name="import_agents" template="import_agents" authority-groups="common">
		<variables>
			<var name="action" value=""/>
		</variables>
		<command class="ecommander.extra.ImportAgents" clear-cache="yes">
			<result name="complete" type="xml"/>
		</command>
	</page>



	<page name="agent_list" template="agent_list" authority-groups="common">
		<variables>
			<var name="cols" scope="cookie"/>
			<var name="country"/>
			<var name="region"/>
			<var name="city"/>
			<var name="type"/>
			<var name="branch"/>
			<var name="sort"/>
			<var name="query"/>
			<var name="message"/>
		</variables>
		
		<item name="all_agents" id="all_agents"/>
		<form item="all_agents" tag="all_agents_form">
			<link name="submit" target="manage_agents"/>
		</form>
		
		<!-- Список агентов -->
		<item name="agent" id="agent">
			<filter>
				<fulltext limit="100" type="prefix" threshold="0.5" compare="ALL"><var var="query"/></fulltext>
				<parameter name="country"><var var="country"/></parameter>
				<parameter name="region"><var var="region"/></parameter>
				<parameter name="city"><var var="city"/></parameter>
				<parameter name="type"><var var="type"/></parameter>
				<parameter name="branch"><var var="branch"/></parameter>
				<sorting direction="ASC"><var var="sort"/></sorting>
			</filter>
			<form item="agent" tag="form">
				<link name="submit" target="manage_agents" copy-page-vars="yes"/>
			</form>
			<link name="delete" target="manage_agents">
				<var name="id" item="agent"/>
			</link>
			<link name="show_proc" target="procurement">
				<var name="id" item="agent"/>
			</link>
		</item>
		
		<item name="agent" id="agent_count" tag="all_agent_qty">
			<filter>
				<limit><var value="1"/></limit>
				<pages><var name="p" value="1"/></pages>
			</filter>
		</item>
		
		<!-- Форма нового агента -->
		<form item-name="agent" tag="new_agent">
			<link name="submit" target="manage_agents" copy-page-vars="yes"/>
		</form>
		
		<!-- Списки параметров агентов -->
		<item name="agent" id="type" tag="types" cacheable="true">
			<aggregation parameter="type"/>
		</item>
		<item name="agent" id="branch" tag="branches" cacheable="true">
			<aggregation parameter="branch"/>
		</item>
		
		<item name="agent_types" tag="types_all">
			<item name="string_element"/>
		</item>
		<item name="agent_branches" tag="branches_all">
			<item name="string_element"/>
		</item>
		
		<!-- Письма для рассылки -->
		<item name="email_catalog">
			<item name="email_section">
				<successor name="email_post"/>
			</item>
		</item>		
		
		<!-- Ссылки для изменения фильтра -->
		<link name="country_base_link" target="agent_list" copy-page-vars="yes">
			<var name="country" value=""/>
		</link>
		<link name="region_base_link" target="agent_list" copy-page-vars="yes">
			<var name="region" value=""/>
		</link>
		<link name="city_base_link" target="agent_list" copy-page-vars="yes">
			<var name="city" value=""/>
		</link>
		<link name="type_base_link" target="agent_list" copy-page-vars="yes">
			<var name="type" value=""/>
		</link>
		<link name="branch_base_link" target="agent_list" copy-page-vars="yes">
			<var name="branch" value=""/>
		</link>
		<link name="cols_base_link" target="agent_list" copy-page-vars="yes">
			<var name="cols" value=""/>
		</link>
		<link name="query_base_link" target="agent_list" copy-page-vars="yes">
			<var name="query" value=""/>
		</link>
		<link name="sort_base_link" target="agent_list" copy-page-vars="yes">
			<var name="sort" value=""/>
		</link>
		<link name="synchronize_site" target="post_email_list"/>
		<link name="get_file" target="agent_file" copy-page-vars="yes"/>
		<link name="add_email_to_queue_no_resend" target="add_email_to_queue"/>
		<link name="add_email_to_queue_resend" target="add_email_to_queue">
			<var name="resend" value="yes"/>
		</link>
		<link name="delete_all" target="manage_agents"/>
	</page>


	<page name="procurement" template="procurement" authority-groups="common">
		<variables>
			<var name="id"/>
		</variables>
		<item name="agent" reference-var="id">
			<item name="procurement">
				<filter>
					<sorting direction="DESC"><var value="date"/></sorting>
				</filter>
			</item>
		</item>
		<link name="to_agents" target="agent_list"/>
	</page>


	<page name="manage_agents" authority-groups="common">
		<variables>
			<var name="id"/>
		</variables>
		<command class="ecommander.extra.ManageAgents" clear-cache="yes">
			<result name="success" type="redirect"/>
			<result name="import" type="redirect"/>
		</command>
		<link name="success" target="agent_list" copy-page-vars="yes">
			<var name="message" value=""/>
		</link>
		<link name="import" target="import_agents">
			<var name="action" value="start"/>
		</link>
	</page>
	
	
	<page name="agent_file" authority-groups="common">
		<headers Content-Type="application/excel" />
		<variables>
			<var name="cols" scope="cookie"/>
			<var name="country"/>
			<var name="region"/>
			<var name="city"/>
			<var name="type"/>
			<var name="branch"/>
			<var name="sort"/>
			<var name="query"/>
		</variables>
		<item name="agent" id="agent">
			<filter>
				<fulltext limit="100" type="prefix" threshold="0.5" compare="ALL"><var var="query"/></fulltext>
				<parameter name="country"><var var="country"/></parameter>
				<parameter name="region"><var var="region"/></parameter>
				<parameter name="city"><var var="city"/></parameter>
				<parameter name="type"><var var="type"/></parameter>
				<parameter name="branch"><var var="branch"/></parameter>
				<sorting direction="ASC"><var var="sort"/></sorting>
			</filter>
		</item>
		<command class="ecommander.extra.AgentFileCommand" clear-cache="yes">
			<result name="success" type="redirect" />
		</command>
	</page>


	<page name="post_email_list" authority-groups="common" template="post_email_list">
		<variables>
			<var name="url" value="http://termobrest.ru/receive_email_list"/>
		</variables>
		<command class="ecommander.extra.PostEmailList"/>
	</page>
	
	<page name="add_email_to_queue" template="send_emails" authority-groups="common">
		<variables>
			<var name="agent_ids"/>
			<var name="email_id"/>
			<var name="resend"/>
		</variables>
		<command class="ecommander.extra.EmailQueueAdd"/>
		<command class="ecommander.extra.EmailQueueSender">
			<result name="complete" type="xml"/>
		</command>
	</page>


	<page name="agent_standard_email" template="agent_standard_email">
		<variables>
			<var name="post"/>
			<var name="agent"/>
		</variables>
		<item name="email_post" reference-var="post"/>
	</page>
	
	<page name="agent_official_email" template="agent_official_email">
		<variables>
			<var name="post"/>
			<var name="agent"/>
		</variables>
		<item name="email_post" reference-var="post"/>
		<item name="agent" reference-var="agent"/>
	</page>
	
	<page name="agent_test_email" template="agent_test_email">
		<variables>
			<var name="post"/>
			<var name="agent"/>
		</variables>
	</page>

	<page name="agent_new_email" template="agent_new_email">
		<variables>
			<var name="post"/>
			<var name="agent"/>
		</variables>
		<item name="email_post" reference-var="post"/>
	</page>

	
	<page name="fix">
		<command class="ecommander.extra.FixAgentsCommand"></command>
	</page>

</site>