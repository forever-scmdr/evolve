Хранение и удаление файлов.

Каждый айтем как и раньше будет иметь свою директорию для файлов. Однако, она не будет вложена в директорию
родтельского айтема, т.к. один айтем может иметь много непосредственных предков с разными ассоциациями, и выделить
главного предка невозможно.
Для того, чтобы не создавать все директории айтемов на одном уровне (в одной родительской), путь к директории должен
разбиваться на поддиректории. Например, если у айтема ID = 123456789, то можно представить его в виде пути
files/123/456/789f/файлы айтема. Символ f в конце название последней директории символизирует то, что она последняя.
Алгоритм такой. ID айтема делится на группы по 3 символа, начиная слева. Если ID <= 999, то в конец ID просто
добавляется f и создается одна директория без поддиректорий. Для каждой группы из 3 символов создаются директории.
Если директория уже создана, то она не создается. Для последней группы из 3, 2 и 1 символов создается директория с
суффиксом f. В ней и будут храниться файлы айтема. При удалении айтема удаляется только его последняя директория
(с суффиксом f) и делается проверка, не пустая ли родительская директория. Если родительская пустая, то и она
удаляется и делается проверка пустоты предыдущей директории и т.д.
Такой механизм позволит иметь не более 2000 директорий на одном уровне вложенности любой родительской директории.
Можно делить директории по 2 символа.


Ограничение доступа к файлам (принадлежность файлов)

При традиционном доступе к файлам есть проблема - любой пользователь, введя url любого файла на сервере (принадлежащий
какому-угодно пользователю и группе), получит этот файл. Для того, чтобы это пресечь, нужно создать на сервере
директории, URL которых будет обрабатываться сервлетом, который должен будет проверять права пользователя на получение
этого файла. Обработку URLа можно сделать через urlrewrite.xml и специальный сервлет.
Каждый айтем можно помечать как (помимо признаков "групповой" и "персональный") доступный или недоступный для
анонимного просмотра.
Если айтем доступен для анонимного просмотра, то файлы сохраняются в директорию files и при
запросах на эти файлы из браузера не производится никаких проверок.
Если айтем не доступен для анонимного просмотра, то файлы сохраняются в директорию protected и не доступны для
скачивания обычными методами. Директория защищена urlrewrite.xml.
Способ получения доступа к защищенным файлам:
К защищенным файлам можно получить доступ только со страницы, требующей авторизации, причем айтемы должны быть загружены
на этой странице. Т.е. можно получить доступ к файлам айтемов, которые были загружены на странице, требующей авторизации.
Таким образом, когда защищенная страница загружается, вместе с ней загружаются и все ее айтемы. Если среди этих айтемов
есть айтемы, защищенные от анонимного просмотра (этот признак надо хранить в айтеме, т.к. он не нужен для логики
загрузки), то их ID сохраняются в сеансе авторизованного пользователя. Когда браузер этого пользователя посылает
запрос на получение защищенного файла, специальный сервлет проверяет наличие ID айтема файла (который получается
сложением частей пути к файлу) в сеансе пользователя. Если файл найден в сеансе, то он отправляется браузеру, иначе
выдается ошибка.

Файлы удаленных и скрытых айтемов

Файлы удаленных айтемов перемещаются в директорию, запрещенную для просмотра deleted, аналогично файлы сркытых айтемов -
в директорию hidden. Обе директории защищены специальным сервлетом.