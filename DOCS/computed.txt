Вычисляемые параметры айтемов (тип computed).

Вычисляемые параметры - это такие параметры айтема, которые получают свое значение на базе значений других параметров
других айтемов (одного или многих). Например, в системе, в которой у каждого товара может быть много предложений от
разных продавцов, товар может хранить максимальную и минимальную цену предложений и количество предложений.
Еще один пример, если поставить тег разделу новостей, то этот же тег добавляется всем новостям в этом разделе.

Для работы механизма вычисляемых параметров нужно:
1. Определения вычисляемых параметров
2. Реестр наблюдателей за изменениями (типов наблюдателей)
3. Журнал изменений базовых айтемов (на базе которых вычисляются значения вычисляемых параметров)
4. Поток актуализации значений вычисляемых параметров (вычисления параметров) на базе журнала изменений

1.

Хранятся в model.xml рядом с обычными параметрами
При определении вычисляемых параметров указывается (самое важное):
- предок или потомок
- ассоциация
- тип айтема
- параметр

2.

На базе определений вычисляемых параметров можно создать реестр типов наблюдателей.
Тогда при сохранении (удалении) айтема происходит поиск в этом реестре типов айтемов, которые должны реагировать
на изменение сохраняемого айтема. Поскольку операция обновелния вычисляемых значений потенциально трудоемкая,
нужно отслеживать не просто изменение айтема, а изменения конкретных базовых параметров.
Если типы айтемов были найдены (по названию типа, ассоциации и параметру), значит нужно вычислять значения computed
параметров для некоторого множества айтемов. В этом случае в журнале изменений делаестя запись, позволяющая найти
айтемы, которые требуют обновления computed параметров.

3.

В общем случае в журнале хранятся записи, по которым можно легко определить, какой айтем (или айтемы) надо обновлять.
В журнале каждый обновляемый айтем должен хранится только один раз, для того, чтобы не делать повторную ненужную
работу. Если айтем из журнала обновлен (т.е. вычислены его computed параметры), то он должен удаляться из журнала.

Если базовый айтем - родитель.
В этом случае скорее всего значения всех наблюдателей будет определять именно этот один айтем. Достаточно сохранить в
журнале ID этого айтема-предка. Если базовый айтем удален, то его надо удалять и из журнала. Если базовый айтем еще раз
был обновлен, то повторно добавлять в журнал нет необходимости, т.к. его последняя редакция послужит базой для
computed параметров айтемов-наблюдателей.

Если базовый айтем - потомок.
В этом случае значение одного и того же предка может определять множество айтемов. Например, продавцы обновили свои
цены на некоторый товар. Было изменено множество айтемов, но подписчиком всех этих айтемов является фактически один
и тот же родительский айтем - товар. Т.е. нет смысла вычислять computed значение для наблюдателя столько раз, сколько
было изменений потомков, достаточно сделать это один раз. Поэтому при сохранении новых значений параметров базового
айтема должна происходить загрузка потенциальных айетмов-наблюдателей. Запись ID этих айтемов в журнал изменений
долджна происходить только в случае, если там еще нет таких значений.
Также если базовый айтем ялвяестя потомком, запись в журнал должна выполняться при удалении, перемещении и копировании
айтема. При удалении должен сохранятся ID родтеля, при копировании - ID нового родителя, а при перемещении - ID и
нового и старого родителей.

4.

Поток должен запускаться через определенный интервал времени. Должна быть возможность отменить выполнение потока,
например, при длительной интеграции, и запуска потока вручную. После выполнения актуализации значений computed
параметров, ссылки на айтемы должны удаляться из журнала. Поток должен фиксировать изменения айетмов и жужрнала в одной
транзакции.